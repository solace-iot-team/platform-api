import { User } from "../../../src/model/user";
import { ContextConstants } from "../../common/constants";
import OrganizationsService from "../services/organizations.service";
import { ns } from './context.handler';
import { ErrorResponseInternal } from "./error.handler";
import L from '../../common/logger';
import Organization = Components.Schemas.Organization;

export default async function orgAuthorizer(req, res, next, org) {
  const url: string = `${req.baseUrl}/${req.url}`.replace('//', '/');
  L.info(`extracting org for ${url}`);
  L.info(`org in namespace is ${ns.getStore().get(ContextConstants.ORG_NAME)}`);
  L.trace("param org is " + org + ' ' + ns.getStore().get(ContextConstants.REQUEST_ID) + ` ${JSON.stringify(ns)}`);
  let user: User = req['user'] as User;
  let err: ErrorResponseInternal = null;
  if (user && user.groups !== null && !user.groups.includes(org)) {
    err = new ErrorResponseInternal(401,
      `User ${user.name} is not a member of [${org}]`
    );
    next(err);
    return;
  }
  if (!user) {
    err = new ErrorResponseInternal(401,
      `User principal missing`
    );
    next(err);
    return;
  }

  try {
    const r: Organization = await OrganizationsService.byName(org);
    L.trace(`router.param org is  ${JSON.stringify(r)}`);
    ns.getStore().set(ContextConstants.ORG_NAME, org);
    ns.getStore().set(ContextConstants.ORG_OBJECT, r);
    ns.getStore().set(ContextConstants.CLOUD_TOKEN, r[ContextConstants.CLOUD_TOKEN]);
    ns.getStore().set(ContextConstants.AUTHENTICATED_USER, req.user.sub);

    L.trace(`router.param ${url} ns org is ` + ns.getStore().get(ContextConstants.ORG_NAME) + ' ' + ns.getStore().get(ContextConstants.REQUEST_ID) + ` ${JSON.stringify(ns)}`);
    next();
  } catch (e) {
    L.debug(`no org matching URI ${req.baseUrl} ${e}`);
    next(new ErrorResponseInternal(404, `Not found`));
  };
}